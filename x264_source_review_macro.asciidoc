:source-highlighter: pygments
:pygments-style: manni

== x264æºç é˜…è¯»ç¬”è®°ï¼šå®çš„ä½¿ç”¨

`x264` æ˜¯H.264æ ‡å‡†çš„ä¸€ä¸ªå¼€æºç¼–ç å™¨ï¼Œä¹Ÿæ˜¯ç›®å‰è¢«å¹¿æ³›ä½¿ç”¨çš„ã€‚å®ƒçš„ä»£ç ä¸»è¦ç”¨Cå†™æˆï¼Œä¹Ÿæœ‰é’ˆå¯¹ä¸åŒæ¶æ„CPUå†™çš„æ±‡ç¼–ï¼Œå› æ­¤å¯ä»¥è¾¾åˆ°å¾ˆé«˜çš„æ€§èƒ½ã€‚[line-through]#AVSçš„å‚è€ƒè½¯ä»¶ä»£ç å®åœ¨å¤ªçƒ‚äº†ï¼Œæ— åŠ›åæ§½ï¼Œçœ‹çœ‹ `x264` çš„å®‰æŠšä¸‹æˆ‘è¢«è¾£å¾—ä¸è¡Œçš„çœ¼ç›ã€‚ã€‚#

è€Œä¸”â€œä¸»è¦ç”¨Câ€ï¼Œâ€œæ•ˆç‡é«˜â€ï¼Œæ»¡è¶³è¿™äº›æ¡ä»¶çš„ä»£ç ä¸€èˆ¬éƒ½æœ‰å¾ˆå¤štricksï¼Œä¸€çœ‹æœä¸å…¶ç„¶ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªä¾‹å­ï¼Œä¼šä¸å®šæœŸæ›´æ–°ã€‚

=== ç®€åŒ–èµ‹å€¼æ“ä½œ

çœ‹è¿™æ®µå¸§å†…é¢„æµ‹çš„ä»£ç ï¼š http://git.videolan.org/?p=x264.git;a=blob;f=common/predict.c#l677[common/predict.c]

`H.264/AVC` ä¸­ï¼Œå¸§å†…é¢„æµ‹æœ‰ä¹ç§æ¨¡å¼ï¼Œä¸‹é¢çš„å‡½æ•°å°±æ˜¯å°†å½“å‰çš„8x8è‰²åº¦å—è®¾ä¸ºå…¶ä¸Šè¾¹ä¸€è¡Œå’Œå·¦è¾¹ä¸€åˆ—åƒç´ çš„å‡å€¼ã€‚

[source, C]
----
void x264_predict_8x8_dc_c( pixel *src, pixel edge[36] )
{
    PREDICT_8x8_LOAD_LEFT
    PREDICT_8x8_LOAD_TOP
    pixel4 dc = PIXEL_SPLAT_X4( (l0+l1+l2+l3+l4+l5+l6+l7+t0+t1+t2+t3+t4+t5+t6+t7+8) >> 4 );
    PREDICT_8x8_DC( dc );
}
----

ä»£ç åªæœ‰å››è¡Œï¼Œæ˜¯å› ä¸ºç”¨åˆ°äº†å®ï¼ŒæŠŠå¤§é‡é‡å¤çš„ä»£ç åšäº†æŠ½è±¡ï¼š

[source, C]
----
#define PL(y) \
    UNUSED int l##y = edge[14-y];
#define PT(x) \
    UNUSED int t##x = edge[16+x];
#define PREDICT_8x8_LOAD_TOPLEFT \
    int lt = edge[15];
#define PREDICT_8x8_LOAD_LEFT \
    PL(0) PL(1) PL(2) PL(3) PL(4) PL(5) PL(6) PL(7)
#define PREDICT_8x8_LOAD_TOP \
    PT(0) PT(1) PT(2) PT(3) PT(4) PT(5) PT(6) PT(7)
#define PREDICT_8x8_LOAD_TOPRIGHT \
    PT(8) PT(9) PT(10) PT(11) PT(12) PT(13) PT(14) PT(15)

#define PREDICT_8x8_DC(v) \
    for( int y = 0; y < 8; y++ ) { \
        MPIXEL_X4( src+0 ) = v; \
        MPIXEL_X4( src+4 ) = v; \
        src += FDEC_STRIDE; \
    }
----

è¿™æ®µå®å®šä¹‰ä¸­æœ‰å‡ ç‚¹éœ€è¦è¯´æ˜ï¼š

* å®çš„ **æ ‡å¿—è¿æ¥** (https://gcc.gnu.org/onlinedocs/cpp/Concatenation.html[token concatenation])ã€‚å³å°† "##" ä¸¤è¾¹çš„æ ‡å¿—åˆå¹¶ä¸ºä¸€ä¸ªæ ‡å¿—ï¼Œè¿™å¯ä»¥ä¸ºæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ èµ·ä¸€ä¸ªæ–¹ä¾¿çš„åå­—ã€‚
* **å‡½æ•°å¼çš„å®** (https://gcc.gnu.org/onlinedocs/cpp/Function-like-Macros.html#Function-like-Macros[Function-like Macros])ã€‚è¿™æ ·çš„å®çœ‹èµ·æ¥å°±åƒåœ¨è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å®æ˜¯ä¸€æ®µä»£ç çš„åˆ«åï¼Œä½œç”¨è·Ÿ `inline` å¤§è‡´ç±»ä¼¼ã€‚æ³¨æ„å¤šè¡Œä»£ç æ¯è¡Œéƒ½éœ€è¦ä½¿ç”¨'\'å¯¹æ¢è¡Œç¬¦è¿›è¡Œè½¬ä¹‰ã€‚
* `UNUSED` çš„å®šä¹‰æ˜¯ `#define UNUSED __attribute__((unused))`ï¼Œæ˜¯è®©ç¼–è¯‘å™¨åœæ­¢å¯¹æœªä½¿ç”¨å˜é‡çš„è­¦å‘Šã€‚è¿™æ˜¯gccçš„ç‰¹æ€§ï¼Œå¦‚æœæ˜¯MSVCï¼Œé‚£ä¹ˆè¿™ä¸ªå®å°±æ˜¯ç©ºçš„ã€‚
* `PIXEL_SPLAT_X4` æ˜¯æŠŠå‡å€¼ï¼ˆ0åˆ°255ï¼‰å¤åˆ¶å››ä»½ï¼Œæ”¾åˆ°ä¸€ä¸ªintä¸­ï¼Œä¹Ÿå°±æ˜¯ä¹˜ä»¥äº† 0x0001000100010001ï¼Œé€šè¿‡ä¸€æ¬¡ä¹˜æ³•ï¼Œå°†ä¸€ä¸ªå€¼å¤åˆ¶äº†å››ä»½ã€‚
* `MPIXEL_X4` æ˜¯å°†å››ä¸ªåƒç´ ä½œä¸ºä¸€ä¸ªè”åˆä½“ï¼Œè¿™æ ·æ¯æ¡intèµ‹å€¼è¯­å¥å¯ä»¥åŒæ—¶ç»™å››ä¸ªåƒç´ èµ‹å€¼ã€‚ ä»£ç è§ http://git.videolan.org/?p=x264.git;a=blob;f=common/common.h#l148[common/common.h]ã€‚æœ¬æ¥éœ€è¦8*8=64æ¬¡çš„èµ‹å€¼æ“ä½œï¼Œç°åœ¨åªéœ€è¦ä¸€æ¬¡ä¹˜æ³•ï¼Œè¿˜æœ‰(8/4)*8=16æ¬¡èµ‹å€¼ã€‚

è¿™é‡Œå¥½åƒä»ä»£ç ä¸­æœªèƒ½ä½“ç°å‡º **æ ‡å¿—è¿æ¥** çš„ä½œç”¨ã€‚å†çœ‹å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯æ°´å¹³æ–¹å‘çš„é¢„æµ‹ï¼Œæ¯è¡Œçš„é¢„æµ‹å€¼éƒ½æ˜¯å¯¹åº”çš„å·¦è¾¹åƒç´ çš„å€¼ï¼š

[source, C]
----
void x264_predict_8x8_h_c( pixel *src, pixel edge[36] )
{
    PREDICT_8x8_LOAD_LEFT
#define ROW(y) MPIXEL_X4( src+y*FDEC_STRIDE+0 ) =\
               MPIXEL_X4( src+y*FDEC_STRIDE+4 ) = PIXEL_SPLAT_X4( l##y );
    ROW(0); ROW(1); ROW(2); ROW(3); ROW(4); ROW(5); ROW(6); ROW(7);
#undef ROW
}
----

åªéœ€è¦æŠŠè¡Œæ•°ä½œä¸ºå‚æ•°ä¼ ç»™ â€œå®å‡½æ•°â€ ROWï¼Œå®ƒå°±è‡ªåŠ¨å°†å¯¹åº”çš„ l0, l1, l2... ç­‰å€¼èµ‹ç»™äº†è¯¥è¡Œçš„8ä¸ªåƒç´ ã€‚å¦‚æœæ²¡æœ‰æ ‡å¿—è¿æ¥ï¼Œå¯èƒ½æ¯ä¸ªæ ‡å¿—éƒ½è¦å®šä¹‰ä¸€ä¸ªå®æ‰å¯è¡Œï¼Œå¦åˆ™å°±è¦ç”¨æ•°ç»„æ¥å‚æ•°åŒ–ã€‚è€Œæ•°ç»„çš„å…ƒç´ å†™èµ·æ¥ä¸æ–¹ä¾¿ï¼ˆæ˜¾ç„¶l0æ¯”l[0]æ›´åŠ æ–¹ä¾¿ï¼‰ï¼Œè€Œä¸”è¿˜å¤šäº†ä¸€æ¬¡å†…å­˜è®¿é—®ã€‚

å†çœ‹ä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼Œå¯èƒ½ä¼šå¯¹â€œl0æ¯”l[0]â€æ›´åŠ æ–¹ä¾¿æœ‰äº›ä½“ä¼šï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å¯¹è§’çº¿å·¦ä¸‹æ–¹å‘(DDL)çš„å¸§å†…é¢„æµ‹ï¼š

[source, C]
----
static void x264_predict_8x8_ddl_c( pixel *src, pixel edge[36] )
{
    PREDICT_8x8_LOAD_TOP
    PREDICT_8x8_LOAD_TOPRIGHT
    SRC(0,0)= F2(t0,t1,t2);
    SRC(0,1)=SRC(1,0)= F2(t1,t2,t3);
    SRC(0,2)=SRC(1,1)=SRC(2,0)= F2(t2,t3,t4);
    SRC(0,3)=SRC(1,2)=SRC(2,1)=SRC(3,0)= F2(t3,t4,t5);
    SRC(0,4)=SRC(1,3)=SRC(2,2)=SRC(3,1)=SRC(4,0)= F2(t4,t5,t6);
    SRC(0,5)=SRC(1,4)=SRC(2,3)=SRC(3,2)=SRC(4,1)=SRC(5,0)= F2(t5,t6,t7);
    SRC(0,6)=SRC(1,5)=SRC(2,4)=SRC(3,3)=SRC(4,2)=SRC(5,1)=SRC(6,0)= F2(t6,t7,t8);
    SRC(0,7)=SRC(1,6)=SRC(2,5)=SRC(3,4)=SRC(4,3)=SRC(5,2)=SRC(6,1)=SRC(7,0)= F2(t7,t8,t9);
    SRC(1,7)=SRC(2,6)=SRC(3,5)=SRC(4,4)=SRC(5,3)=SRC(6,2)=SRC(7,1)= F2(t8,t9,t10);
    SRC(2,7)=SRC(3,6)=SRC(4,5)=SRC(5,4)=SRC(6,3)=SRC(7,2)= F2(t9,t10,t11);
    SRC(3,7)=SRC(4,6)=SRC(5,5)=SRC(6,4)=SRC(7,3)= F2(t10,t11,t12);
    SRC(4,7)=SRC(5,6)=SRC(6,5)=SRC(7,4)= F2(t11,t12,t13);
    SRC(5,7)=SRC(6,6)=SRC(7,5)= F2(t12,t13,t14);
    SRC(6,7)=SRC(7,6)= F2(t13,t14,t15);
    SRC(7,7)= F2(t14,t15,t15);
}
----

ä½†æˆ‘æƒ³ `x264` ç»™æ•°ç»„å…ƒç´ èµ·åå­—çš„åšæ³•ä¸åªæ˜¯ä¸ºäº†æ–¹ä¾¿ï¼Œæ›´é‡è¦çš„è¿˜æ˜¯æ€§èƒ½å§ï¼

=== inlineå‡½æ•°

http://git.videolan.org/?p=x264.git;a=blob;f=common/common.h#l290[common/common.h] ä¸­å®šä¹‰äº†å–ä¸­ä½æ•°çš„ä¸€ä¸ªinlineå‡½æ•°ã€‚ç”±äºå®ƒæ€»æ˜¯è¢«å¼ºåˆ¶inlineï¼Œä½œç”¨å°±ç›¸å½“äºå®äº†ã€‚

[source, C]
----
static ALWAYS_INLINE int x264_median( int a, int b, int c )
{
    int t = (a-b)&((a-b)>>31);
    a -= t;
    b += t;
    b -= (b-c)&((b-c)>>31);
    b += (a-b)&((a-b)>>31);
    return b;
}
----

ç„¶è€Œè¿™ä¸ªå–ä¸­ä½æ•°çš„å‡½æ•°ï¼ˆä»åå­—ä¸Šçœ‹ï¼‰ä¸ºä»€ä¹ˆè¿™æ ·å†™ï¼Œä¼¼ä¹ä¸é‚£ä¹ˆæ˜¾ç„¶ã€‚é€æ¡è¯­å¥åˆ†æä¸‹å§ï¼š

* `int t = (a-b)&((a-b)>>31);`
    ** (a-b)>>31 ç›¸å½“äº (a < b ? 1 : 0)ï¼Œé‚£ä¹ˆè¿™æ¡è¯­å¥å…¶å®å¯å†™ä½œ `int t = (a < b) ? ((a-b)&1) : 0;` a < bä¸”aä¸bçš„å·®å€¼æ˜¯å¥‡æ•°æ—¶ï¼Œt=1ï¼Œå…¶ä½™æƒ…å†µtå‡ä¸º0.
* `a -= t; b += t;` å½“tä¸º0æ—¶ï¼Œè¿™ä¸¤æ¡è¯­å¥æ²¡æœ‰ä½œç”¨ã€‚è€ƒè™‘å½“t=1ï¼Œå³â€œa<bä¸”b-aä¸ºå¥‡æ•°â€æ—¶ï¼Œè¿™ä¸¤æ¡è¯­å¥ä½¿å¾— a,b çš„å·®æ‰©å¤§äº†2ï¼Œè€Œä¸”å¥‡å¶æ€§äº’æ¢ã€‚
* `b -= (b-c)&((b-c)>>31);` â€œb<cä¸”c-bä¸ºå¥‡æ•°â€æ—¶ï¼Œb-=1ï¼Œå¦åˆ™bä¸å˜ã€‚
* `b += (a-b)&((a-b)>>31);` â€œa<bä¸”b-aä¸ºå¥‡æ•°â€æ—¶ï¼Œb+=1ï¼Œå¦åˆ™bä¸å˜ã€‚

è²Œä¼¼è¿˜æ˜¯åˆ†æä¸å‡ºæ¥ã€‚é¢ï¼Œä¸¾ä¸ªä¾‹å­ä»£å…¥çœ‹çœ‹ï¼š

[source, C]
----
static ALWAYS_INLINE int x264_median( int a, int b, int c )// (a, b, c) = (3, 9 ,7)
{
    int t = (a-b)&((a-b)>>31);// t = (-6)&1 = 0 
    a -= t; // (3, 9, 7)
    b += t; // (3, 9, 7)
    b -= (b-c)&((b-c)>>31); // (3, 9, 7)
    b += (a-b)&((a-b)>>31); // (3, 9, 7)
    return b; // 9
}
----

ä¸æ‡‚ã€‚ã€‚

é¢ï¼Œé‚£å•¥ï¼ˆç©å„¿è„±äº†ï¼š|ï¼‰ï¼Œçœ‹çœ‹ **ALWAYS_INLINE** è¿™ä¸ªå®å§ğŸ˜‚ï¼

[source, C]
----
#if defined(__GNUC__) && (__GNUC__ > 3 || __GNUC__ == 3 && __GNUC_MINOR__ > 0)
#define UNUSED __attribute__((unused))
#define ALWAYS_INLINE __attribute__((always_inline)) inline
#define NOINLINE __attribute__((noinline))
#else
#ifdef _MSC_VER
#define ALWAYS_INLINE __forceinline
#define NOINLINE __declspec(noinline)
#else
#define ALWAYS_INLINE inline
#define NOINLINE
#endif
#define UNUSED
#endif
----

æ²¡å•¥å¯è¯´çš„ï¼Œçœ‹çœ‹æ€ä¹ˆç»™ä¸åŒçš„ç¼–è¯‘å™¨æ·»åŠ ç‰¹æ€§çš„å§ã€‚
åæ§½ä¸‹VSçš„ç‰ˆæœ¬å·ï¼š

    MSVC++ 14.0 _MSC_VER == 1900 (Visual Studio 2015)
    MSVC++ 12.0 _MSC_VER == 1800 (Visual Studio 2013)
    MSVC++ 11.0 _MSC_VER == 1700 (Visual Studio 2012)
    MSVC++ 10.0 _MSC_VER == 1600 (Visual Studio 2010)
    MSVC++ 9.0  _MSC_VER == 1500 (Visual Studio 2008)
    MSVC++ 8.0  _MSC_VER == 1400 (Visual Studio 2005)
    MSVC++ 7.1  _MSC_VER == 1310 (Visual Studio 2003)
    MSVC++ 7.0  _MSC_VER == 1300
    MSVC++ 6.0  _MSC_VER == 1200
    MSVC++ 5.0  _MSC_VER == 1100
